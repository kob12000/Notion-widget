<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Hours</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #191919;
    color: #e2e4e9;
    font-family: 'Outfit', sans-serif;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  .widget {
    width: 100%;
    max-width: 520px;
    background: #1e1e1e;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px;
    overflow: hidden;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .header-left { display: flex; align-items: center; gap: 8px; }
  .header-icon {
    width: 18px; height: 18px; border-radius: 50%;
    border: 2px solid #3b82f6; position: relative;
  }
  .header-icon::before {
    content: ''; position: absolute; top: 50%; left: 50%;
    width: 6px; height: 1.5px; background: #3b82f6;
    transform-origin: left center; transform: translate(0, -50%) rotate(-45deg);
  }
  .header-icon::after {
    content: ''; position: absolute; top: 50%; left: 50%;
    width: 4px; height: 1.5px; background: #3b82f6;
    transform-origin: left center; transform: translate(0, -50%) rotate(-160deg);
  }
  .header-title {
    font-size: 13px; font-weight: 600; letter-spacing: 0.5px;
    text-transform: uppercase; color: #8b8fa3;
  }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .dst-badge {
    font-size: 9px; font-weight: 600; letter-spacing: 0.5px;
    padding: 2px 6px; border-radius: 4px;
    background: rgba(250, 204, 21, 0.1); color: #facc15; display: none;
  }
  .dst-badge.visible { display: inline-block; }
  .utc-time {
    font-family: 'JetBrains Mono', monospace; font-size: 13px;
    font-weight: 500; color: #5b6178; letter-spacing: 0.5px;
  }
  .map-section {
    position: relative; padding: 10px 18px 6px;
    height: 160px; overflow: hidden;
  }
  .map-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  .timeline-section { padding: 6px 18px 14px; }
  .timeline-header {
    display: flex; justify-content: space-between;
    padding: 0 2px; margin-bottom: 6px;
  }
  .timeline-hour {
    font-family: 'JetBrains Mono', monospace; font-size: 9px;
    color: #3a3e4f; width: 0; text-align: center;
  }
  .session-row { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
  .session-label { width: 64px; flex-shrink: 0; display: flex; align-items: center; gap: 6px; }
  .session-flag { font-size: 14px; line-height: 1; }
  .session-name { font-size: 11px; font-weight: 600; color: #8b8fa3; letter-spacing: 0.3px; }
  .session-bar-container {
    flex: 1; height: 22px; background: rgba(255,255,255,0.02);
    border-radius: 4px; position: relative; overflow: hidden;
  }
  .session-bar {
    position: absolute; height: 100%; border-radius: 4px; transition: opacity 0.3s;
  }
  .session-bar.active { animation: barPulse 3s ease-in-out infinite; }
  @keyframes barPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.75; } }
  .session-bar.inactive { opacity: 0.2; }
  .bar-asia { background: linear-gradient(90deg, #f43f5e, #fb7185); }
  .bar-london { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
  .bar-nyse { background: linear-gradient(90deg, #10b981, #34d399); }
  .now-line {
    position: absolute; top: 0; height: 100%; width: 1.5px;
    background: #facc15; z-index: 10;
    box-shadow: 0 0 6px rgba(250, 204, 21, 0.4);
  }
  .status-section { padding: 4px 18px 16px; display: flex; flex-direction: column; gap: 6px; }
  .status-card {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px; background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.04); border-radius: 10px;
    transition: border-color 0.3s;
  }
  .status-card.open { border-color: rgba(255,255,255,0.08); }
  .status-left { display: flex; align-items: center; gap: 10px; }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .status-dot.open { animation: dotPulse 2s ease-in-out infinite; }
  @keyframes dotPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5); }
    50% { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
  }
  .dot-asia { background: #f43f5e; }
  .dot-london { background: #3b82f6; }
  .dot-nyse { background: #10b981; }
  .status-info { display: flex; flex-direction: column; gap: 1px; }
  .status-market { font-size: 12.5px; font-weight: 600; color: #e2e4e9; }
  .status-hours {
    font-family: 'JetBrains Mono', monospace; font-size: 10px;
    color: #4a4f65; letter-spacing: 0.3px;
  }
  .status-right {
    text-align: right; display: flex; flex-direction: column;
    align-items: flex-end; gap: 1px;
  }
  .status-state { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
  .state-open { color: #10b981; }
  .state-closed { color: #ef4444; }
  .status-countdown {
    font-family: 'JetBrains Mono', monospace; font-size: 11.5px;
    font-weight: 500; color: #8b8fa3; letter-spacing: 0.5px;
  }
  .countdown-label {
    font-family: 'Outfit', sans-serif; font-size: 9.5px;
    color: #4a4f65; font-weight: 400; letter-spacing: 0;
  }
</style>
</head>
<body>
<div class="widget">
  <div class="header">
    <div class="header-left">
      <div class="header-icon"></div>
      <span class="header-title">Market Hours</span>
    </div>
    <div class="header-right">
      <span class="dst-badge" id="dstBadge">DST</span>
      <span class="utc-time" id="utcClock">00:00:00 UTC</span>
    </div>
  </div>
  <div class="map-section">
    <canvas class="map-canvas" id="mapCanvas"></canvas>
  </div>
  <div class="timeline-section">
    <div class="timeline-header" id="timelineHeader"></div>
    <div id="timelineRows"></div>
  </div>
  <div class="status-section" id="statusCards"></div>
</div>
<script>
// === DST Detection ===
function isUSDST(date) {
  const y = date.getUTCFullYear();
  let d = 1, c = 0;
  while (c < 2) { if (new Date(Date.UTC(y, 2, d)).getUTCDay() === 0) c++; if (c < 2) d++; }
  const start = new Date(Date.UTC(y, 2, d, 7));
  d = 1; c = 0;
  while (c < 1) { if (new Date(Date.UTC(y, 10, d)).getUTCDay() === 0) c++; if (c < 1) d++; }
  const end = new Date(Date.UTC(y, 10, d, 6));
  return date >= start && date < end;
}
function isEUDST(date) {
  const y = date.getUTCFullYear();
  let d = 31;
  while (new Date(Date.UTC(y, 2, d)).getUTCDay() !== 0) d--;
  const start = new Date(Date.UTC(y, 2, d, 1));
  d = 31;
  while (new Date(Date.UTC(y, 9, d)).getUTCDay() !== 0) d--;
  const end = new Date(Date.UTC(y, 9, d, 1));
  return date >= start && date < end;
}

// === Markets ===
// Sources: FXOpen/TradingView, Myfxbook, Babypips, FOREX.com
// Winter = standard time, Summer = DST active
const MARKETS = [
  {
    id: 'asia', name: 'Asia', label: 'Tokyo', flag: 'ðŸ‡¯ðŸ‡µ',
    // Tokyo forex session: 00:00â€“09:00 UTC (no DST in Japan)
    winterOpen: 0, winterClose: 9,
    summerOpen: 0, summerClose: 9,
    hasDST: false,
    color: '#f43f5e', barClass: 'bar-asia', dotClass: 'dot-asia',
    mapX: 0.82, mapY: 0.35
  },
  {
    id: 'london', name: 'London', label: 'London', flag: 'ðŸ‡¬ðŸ‡§',
    // London forex: Winter 08:00â€“17:00 UTC, Summer 07:00â€“16:00 UTC
    winterOpen: 8, winterClose: 17,
    summerOpen: 7, summerClose: 16,
    hasDST: true, dstRegion: 'EU',
    color: '#3b82f6', barClass: 'bar-london', dotClass: 'dot-london',
    mapX: 0.47, mapY: 0.28
  },
  {
    id: 'nyse', name: 'NYSE', label: 'NYSE', flag: 'ðŸ‡ºðŸ‡¸',
    // NYSE: Winter 14:30â€“21:00 UTC, Summer 13:30â€“20:00 UTC
    winterOpen: 14.5, winterClose: 21,
    summerOpen: 13.5, summerClose: 20,
    hasDST: true, dstRegion: 'US',
    color: '#10b981', barClass: 'bar-nyse', dotClass: 'dot-nyse',
    mapX: 0.22, mapY: 0.33
  }
];

// === Holiday Detection ===
// Helper: Nth weekday of a month (e.g. 3rd Monday of January)
function nthWeekday(year, month, weekday, n) {
  let count = 0, d = 1;
  while (count < n) {
    if (new Date(Date.UTC(year, month, d)).getUTCDay() === weekday) count++;
    if (count < n) d++;
  }
  return d;
}
// Helper: Last Monday of a month
function lastMonday(year, month) {
  const lastDay = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
  let d = lastDay;
  while (new Date(Date.UTC(year, month, d)).getUTCDay() !== 1) d--;
  return d;
}
// Easter (Anonymous Gregorian algorithm)
function easterDate(year) {
  const a = year % 19, b = Math.floor(year/100), c = year % 100;
  const d = Math.floor(b/4), e = b % 4, f = Math.floor((b+8)/25);
  const g = Math.floor((b-f+1)/3), h = (19*a+b-d-g+15) % 30;
  const i = Math.floor(c/4), k = c % 4;
  const l = (32+2*e+2*i-h-k) % 7;
  const m = Math.floor((a+11*h+22*l)/451);
  const month = Math.floor((h+l-7*m+114)/31) - 1;
  const day = ((h+l-7*m+114) % 31) + 1;
  return { month, day };
}

function getUSHolidays(year) {
  const easter = easterDate(year);
  return [
    { m: 0, d: 1, name: "New Year's Day" },
    { m: 0, d: nthWeekday(year, 0, 1, 3), name: 'MLK Day' },
    { m: 1, d: nthWeekday(year, 1, 1, 3), name: "Presidents' Day" },
    { m: easter.month, d: easter.day - 2, name: 'Good Friday' },
    { m: 4, d: lastMonday(year, 4), name: 'Memorial Day' },
    { m: 5, d: 19, name: 'Juneteenth' },
    { m: 6, d: 4, name: 'Independence Day' },
    { m: 8, d: nthWeekday(year, 8, 1, 1), name: 'Labor Day' },
    { m: 10, d: nthWeekday(year, 10, 4, 4), name: 'Thanksgiving' },
    { m: 11, d: 25, name: 'Christmas' },
  ];
}

function getUKHolidays(year) {
  const easter = easterDate(year);
  const easterDt = new Date(Date.UTC(year, easter.month, easter.day));
  const goodFriday = new Date(easterDt - 2 * 86400000);
  const easterMon = new Date(+easterDt + 86400000);
  // If Dec 25 is Satâ†’sub Mon 27, if Sunâ†’sub Mon 27 Tue 28
  // If Dec 26 is Satâ†’sub Mon 28, if Sunâ†’sub Tue 28
  const xmasDay = new Date(Date.UTC(year, 11, 25)).getUTCDay();
  let xmasSubs = [{ m: 11, d: 25 }, { m: 11, d: 26 }];
  if (xmasDay === 6) xmasSubs = [{ m: 11, d: 27 }, { m: 11, d: 28 }];
  else if (xmasDay === 0) xmasSubs = [{ m: 11, d: 27 }, { m: 11, d: 28 }];
  else if (xmasDay === 5) xmasSubs = [{ m: 11, d: 25 }, { m: 11, d: 28 }];
  // If Jan 1 is Satâ†’sub Mon Jan 3, if Sunâ†’sub Mon Jan 2
  const nyDay = new Date(Date.UTC(year, 0, 1)).getUTCDay();
  let nySub = { m: 0, d: 1, name: "New Year's Day" };
  if (nyDay === 6) nySub = { m: 0, d: 3, name: "New Year's Day" };
  else if (nyDay === 0) nySub = { m: 0, d: 2, name: "New Year's Day" };

  return [
    nySub,
    { m: goodFriday.getUTCMonth(), d: goodFriday.getUTCDate(), name: 'Good Friday' },
    { m: easterMon.getUTCMonth(), d: easterMon.getUTCDate(), name: 'Easter Monday' },
    { m: 4, d: nthWeekday(year, 4, 1, 1), name: 'Early May Bank Holiday' },
    { m: 4, d: lastMonday(year, 4), name: 'Spring Bank Holiday' },
    { m: 7, d: lastMonday(year, 7), name: 'Summer Bank Holiday' },
    ...xmasSubs.map(s => ({ ...s, name: 'Christmas/Boxing' })),
  ];
}

function isHoliday(market, now) {
  if (market.id === 'asia') return false; // Forex session, no holidays
  const y = now.getUTCFullYear();
  const m = now.getUTCMonth();
  const d = now.getUTCDate();
  const holidays = market.id === 'nyse' ? getUSHolidays(y) : getUKHolidays(y);
  // For US fixed-date holidays (Juneteenth, July 4, Christmas, NY): if falls on Satâ†’observed Fri, Sunâ†’observed Mon
  if (market.id === 'nyse') {
    return holidays.some(h => {
      let hm = h.m, hd = h.d;
      // Adjust fixed-date holidays for observed day
      if (['Juneteenth','Independence Day','Christmas',"New Year's Day"].includes(h.name)) {
        const dow = new Date(Date.UTC(y, hm, hd)).getUTCDay();
        if (dow === 6) hd -= 1; // Saturday â†’ Friday
        if (dow === 0) hd += 1; // Sunday â†’ Monday
      }
      return m === hm && d === hd;
    });
  }
  return holidays.some(h => m === h.m && d === h.d);
}

function getHolidayName(market, now) {
  if (market.id === 'asia') return null;
  const y = now.getUTCFullYear();
  const m = now.getUTCMonth();
  const d = now.getUTCDate();
  const holidays = market.id === 'nyse' ? getUSHolidays(y) : getUKHolidays(y);
  if (market.id === 'nyse') {
    for (const h of holidays) {
      let hd = h.d;
      if (['Juneteenth','Independence Day','Christmas',"New Year's Day"].includes(h.name)) {
        const dow = new Date(Date.UTC(y, h.m, hd)).getUTCDay();
        if (dow === 6) hd -= 1;
        if (dow === 0) hd += 1;
      }
      if (m === h.m && d === hd) return h.name;
    }
  } else {
    for (const h of holidays) {
      if (m === h.m && d === h.d) return h.name;
    }
  }
  return null;
}

// === Helpers ===
function getSessionTimes(m, now) {
  if (!m.hasDST) return { open: m.winterOpen, close: m.winterClose, isDST: false };
  let dst = false;
  if (m.dstRegion === 'US') dst = isUSDST(now);
  if (m.dstRegion === 'EU') dst = isEUDST(now);
  return dst
    ? { open: m.summerOpen, close: m.summerClose, isDST: true }
    : { open: m.winterOpen, close: m.winterClose, isDST: false };
}

function isWeekend(now) { const d = now.getUTCDay(); return d === 0 || d === 6; }

function isMarketOpen(market, utcH, now) {
  if (isWeekend(now)) return false;
  if (isHoliday(market, now)) return false;
  const { open, close } = getSessionTimes(market, now);
  if (now.getUTCDay() === 5 && utcH >= close) return false;
  return (open < close) ? (utcH >= open && utcH < close) : (utcH >= open || utcH < close);
}

function formatTime(h) {
  const hr = Math.floor(h) % 24;
  const mn = Math.round((h - Math.floor(h)) * 60);
  return `${String(hr).padStart(2,'0')}:${String(mn).padStart(2,'0')}`;
}

function msToCountdown(ms) {
  if (ms <= 0) return '00h 00m 00s';
  const s = Math.floor(ms / 1000);
  return `${String(Math.floor(s/3600)).padStart(2,'0')}h ${String(Math.floor((s%3600)/60)).padStart(2,'0')}m ${String(s%60).padStart(2,'0')}s`;
}

function getTargetDate(now, dayOffset, hourUTC) {
  return new Date(Date.UTC(
    now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + dayOffset,
    Math.floor(hourUTC), Math.round((hourUTC % 1) * 60), 0
  ));
}

// Find next open day for a market (skips weekends and holidays)
function daysUntilNextOpen(market, now) {
  for (let i = 1; i <= 10; i++) {
    const future = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + i));
    const fDay = future.getUTCDay();
    if (fDay === 0 || fDay === 6) continue;
    if (isHoliday(market, future)) continue;
    return i;
  }
  return 1; // fallback
}

function getCountdown(market, utcH, now) {
  const day = now.getUTCDay();
  const { open, close } = getSessionTimes(market, now);

  // Weekend
  if (day === 6 || day === 0) {
    const daysToMon = day === 6 ? 2 : 1;
    // But Monday might be a holiday, check further
    const nextDay = daysUntilNextOpen(market, now);
    const label = nextDay <= 3 ? 'reopens Monday' : 'holiday';
    return { open: false, label: label, time: msToCountdown(getTargetDate(now, nextDay, open) - now), holiday: null };
  }

  // Holiday today
  if (isHoliday(market, now)) {
    const hName = getHolidayName(market, now);
    const nextDay = daysUntilNextOpen(market, now);
    return { open: false, label: hName || 'holiday', time: msToCountdown(getTargetDate(now, nextDay, open) - now), holiday: hName };
  }

  // Friday after close
  if (day === 5 && utcH >= close) {
    const nextDay = daysUntilNextOpen(market, now);
    return { open: false, label: 'reopens Monday', time: msToCountdown(getTargetDate(now, nextDay, open) - now), holiday: null };
  }

  // Currently open
  if (isMarketOpen(market, utcH, now)) {
    return { open: true, label: 'closes in', time: msToCountdown(getTargetDate(now, 0, close) - now), holiday: null };
  }

  // Before open today
  if (utcH < open) {
    return { open: false, label: 'opens in', time: msToCountdown(getTargetDate(now, 0, open) - now), holiday: null };
  }

  // After close today
  const nextDay = daysUntilNextOpen(market, now);
  const label = nextDay === 1 ? 'opens tomorrow' : 'reopens in ' + nextDay + 'd';
  return { open: false, label: label, time: msToCountdown(getTargetDate(now, nextDay, open) - now), holiday: null };
}

// === Map ===
function generateMapDots() {
  const c = {
    na: [[.10,.20],[.12,.18],[.14,.17],[.16,.16],[.18,.16],[.20,.16],[.22,.18],[.24,.20],[.12,.22],[.14,.22],[.16,.20],[.18,.20],[.20,.20],[.22,.22],[.24,.24],[.10,.24],[.12,.26],[.14,.26],[.16,.24],[.18,.24],[.20,.24],[.22,.26],[.10,.28],[.12,.28],[.14,.28],[.16,.28],[.18,.28],[.20,.28],[.12,.30],[.14,.30],[.16,.30],[.18,.30],[.20,.30],[.14,.32],[.16,.32],[.18,.32],[.16,.34],[.18,.34],[.20,.32],[.22,.30],[.24,.28],[.26,.26],[.08,.18],[.10,.16],[.12,.14],[.14,.14],[.16,.14],[.18,.14],[.20,.14],[.08,.20],[.06,.20],[.08,.22],[.08,.16],[.24,.22],[.26,.24],[.26,.28],[.28,.26],[.16,.36],[.18,.36],[.18,.38],[.20,.38],[.20,.36]],
    sa: [[.24,.46],[.26,.44],[.28,.42],[.26,.46],[.28,.46],[.24,.48],[.26,.48],[.28,.48],[.30,.46],[.30,.48],[.24,.50],[.26,.50],[.28,.50],[.30,.50],[.26,.52],[.28,.52],[.30,.52],[.32,.50],[.26,.54],[.28,.54],[.30,.54],[.26,.56],[.28,.56],[.30,.56],[.26,.58],[.28,.58],[.26,.60],[.28,.60],[.26,.62],[.28,.62],[.26,.64],[.28,.64],[.26,.66],[.28,.66],[.26,.68],[.27,.70]],
    eu: [[.44,.18],[.46,.18],[.48,.18],[.50,.18],[.52,.18],[.44,.20],[.46,.20],[.48,.20],[.50,.20],[.52,.20],[.54,.20],[.44,.22],[.46,.22],[.48,.22],[.50,.22],[.52,.22],[.54,.22],[.44,.24],[.46,.24],[.48,.24],[.50,.24],[.52,.24],[.46,.26],[.48,.26],[.50,.26],[.52,.26],[.46,.28],[.48,.28],[.50,.28],[.42,.20],[.42,.22],[.44,.26],[.54,.18],[.56,.18],[.56,.20],[.56,.22],[.58,.18],[.58,.20]],
    af: [[.46,.34],[.48,.34],[.50,.34],[.52,.34],[.44,.36],[.46,.36],[.48,.36],[.50,.36],[.52,.36],[.54,.36],[.44,.38],[.46,.38],[.48,.38],[.50,.38],[.52,.38],[.54,.38],[.46,.40],[.48,.40],[.50,.40],[.52,.40],[.54,.40],[.56,.40],[.46,.42],[.48,.42],[.50,.42],[.52,.42],[.54,.42],[.56,.42],[.46,.44],[.48,.44],[.50,.44],[.52,.44],[.54,.44],[.48,.46],[.50,.46],[.52,.46],[.54,.46],[.48,.48],[.50,.48],[.52,.48],[.50,.50],[.52,.50],[.50,.52],[.52,.52],[.50,.54],[.46,.32],[.48,.32],[.50,.32],[.52,.32],[.54,.32]],
    as: [[.60,.18],[.62,.18],[.64,.18],[.66,.18],[.68,.18],[.70,.18],[.60,.20],[.62,.20],[.64,.20],[.66,.20],[.68,.20],[.70,.20],[.72,.20],[.58,.22],[.60,.22],[.62,.22],[.64,.22],[.66,.22],[.68,.22],[.70,.22],[.72,.22],[.74,.22],[.58,.24],[.60,.24],[.62,.24],[.64,.24],[.66,.24],[.68,.24],[.70,.24],[.72,.24],[.74,.24],[.56,.26],[.58,.26],[.60,.26],[.62,.26],[.64,.26],[.66,.26],[.68,.26],[.70,.26],[.72,.26],[.74,.26],[.56,.28],[.58,.28],[.60,.28],[.62,.28],[.64,.28],[.66,.28],[.68,.28],[.70,.28],[.72,.28],[.74,.28],[.56,.30],[.58,.30],[.60,.30],[.62,.30],[.64,.30],[.66,.30],[.68,.30],[.70,.30],[.72,.30],[.58,.32],[.60,.32],[.62,.32],[.64,.32],[.66,.32],[.68,.32],[.70,.32],[.60,.34],[.62,.34],[.64,.34],[.66,.34],[.68,.34],[.70,.34],[.62,.36],[.64,.36],[.66,.36],[.68,.36],[.64,.38],[.66,.38],[.76,.22],[.76,.24],[.78,.24],[.78,.26],[.80,.26],[.80,.28],[.82,.28],[.82,.30],[.84,.30],[.82,.32],[.84,.32],[.80,.30],[.80,.32],[.82,.34],[.84,.34],[.84,.28],[.86,.28],[.86,.30],[.86,.32],[.84,.26]],
    au: [[.76,.52],[.78,.52],[.80,.52],[.82,.52],[.84,.52],[.74,.54],[.76,.54],[.78,.54],[.80,.54],[.82,.54],[.84,.54],[.86,.54],[.74,.56],[.76,.56],[.78,.56],[.80,.56],[.82,.56],[.84,.56],[.86,.56],[.76,.58],[.78,.58],[.80,.58],[.82,.58],[.84,.58],[.78,.60],[.80,.60],[.82,.60],[.84,.60],[.80,.62],[.82,.62]]
  };
  const dots = [];
  Object.values(c).forEach(a => dots.push(...a));
  return dots;
}
const mapDots = generateMapDots();

function drawMap(canvas) {
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const w = rect.width, h = rect.height;
  ctx.clearRect(0, 0, w, h);
  mapDots.forEach(([x, y]) => {
    ctx.beginPath(); ctx.arc(x*w, y*h, 1.5, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,0.07)'; ctx.fill();
  });
  const now = new Date();
  const utcH = now.getUTCHours() + now.getUTCMinutes()/60;
  MARKETS.forEach(m => {
    const isOpen = isMarketOpen(m, utcH, now);
    const cx = m.mapX*w, cy = m.mapY*h;
    if (isOpen) {
      const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, 28);
      g.addColorStop(0, m.color+'30'); g.addColorStop(1, m.color+'00');
      ctx.beginPath(); ctx.arc(cx, cy, 28, 0, Math.PI*2); ctx.fillStyle = g; ctx.fill();
    }
    ctx.beginPath(); ctx.arc(cx, cy, 6, 0, Math.PI*2);
    ctx.fillStyle = isOpen ? m.color+'40' : 'rgba(255,255,255,0.06)'; ctx.fill();
    ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2);
    ctx.fillStyle = isOpen ? m.color : 'rgba(255,255,255,0.15)'; ctx.fill();
    ctx.font = '500 9.5px Outfit, sans-serif';
    ctx.fillStyle = isOpen ? m.color : '#4a4f65';
    ctx.textAlign = 'center'; ctx.fillText(m.label, cx, cy-12);
  });
}

// === Build UI ===
function buildTimeline() {
  const now = new Date();
  document.getElementById('timelineHeader').innerHTML =
    [0,4,8,12,16,20,24].map(h => `<span class="timeline-hour">${String(h%24).padStart(2,'0')}</span>`).join('');
  document.getElementById('timelineRows').innerHTML = MARKETS.map(m => {
    const { open, close } = getSessionTimes(m, now);
    return `<div class="session-row">
      <div class="session-label"><span class="session-flag">${m.flag}</span><span class="session-name">${m.label}</span></div>
      <div class="session-bar-container" id="bar-${m.id}">
        <div class="session-bar ${m.barClass}" style="left:${(open/24)*100}%;width:${((close-open)/24)*100}%" id="barFill-${m.id}"></div>
        <div class="now-line" id="nowLine-${m.id}"></div>
      </div>
    </div>`;
  }).join('');
}

function buildStatusCards() {
  const now = new Date();
  document.getElementById('statusCards').innerHTML = MARKETS.map(m => {
    const { open, close, isDST } = getSessionTimes(m, now);
    const dstTag = isDST ? ' <span style="color:#facc15;font-size:9px">(DST)</span>' : '';
    return `<div class="status-card" id="card-${m.id}">
      <div class="status-left">
        <div class="status-dot ${m.dotClass}" id="dot-${m.id}"></div>
        <div class="status-info">
          <span class="status-market">${m.flag} ${m.name}${dstTag}</span>
          <span class="status-hours">${formatTime(open)} â€“ ${formatTime(close)} UTC</span>
        </div>
      </div>
      <div class="status-right">
        <span class="status-state" id="state-${m.id}"></span>
        <span class="status-countdown" id="countdown-${m.id}"></span>
        <span class="countdown-label" id="countdownLabel-${m.id}"></span>
      </div>
    </div>`;
  }).join('');
}

// === Update ===
function update() {
  const now = new Date();
  const utcH = now.getUTCHours() + now.getUTCMinutes()/60 + now.getUTCSeconds()/3600;
  document.getElementById('utcClock').textContent =
    `${String(now.getUTCHours()).padStart(2,'0')}:${String(now.getUTCMinutes()).padStart(2,'0')}:${String(now.getUTCSeconds()).padStart(2,'0')} UTC`;
  const anyDST = MARKETS.some(m => {
    if (!m.hasDST) return false;
    return m.dstRegion === 'US' ? isUSDST(now) : isEUDST(now);
  });
  document.getElementById('dstBadge').className = `dst-badge ${anyDST ? 'visible' : ''}`;
  const nowPct = (utcH/24)*100;
  MARKETS.forEach(m => {
    document.getElementById(`nowLine-${m.id}`).style.left = `${nowPct}%`;
    const open = isMarketOpen(m, utcH, now);
    document.getElementById(`barFill-${m.id}`).className = `session-bar ${m.barClass} ${open ? 'active' : 'inactive'}`;
    const info = getCountdown(m, utcH, now);
    document.getElementById(`card-${m.id}`).className = `status-card ${info.open ? 'open' : ''}`;
    document.getElementById(`dot-${m.id}`).className = `status-dot ${m.dotClass} ${info.open ? 'open' : ''}`;
    const st = document.getElementById(`state-${m.id}`);
    st.className = `status-state ${info.open ? 'state-open' : 'state-closed'}`;
    st.textContent = info.open ? 'OPEN' : 'CLOSED';
    document.getElementById(`countdown-${m.id}`).textContent = info.time;
    document.getElementById(`countdownLabel-${m.id}`).textContent = info.holiday ? info.holiday : info.label;
  });
  drawMap(document.getElementById('mapCanvas'));
}

buildTimeline();
buildStatusCards();
update();
setInterval(update, 1000);
window.addEventListener('resize', () => drawMap(document.getElementById('mapCanvas')));
</script>
</body>
</html>
